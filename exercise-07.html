<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>exercise-07.knit</title>

<script src="site_libs/header-attrs-2.11/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/paper.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>








<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Phylogenetics</a>
</li>
<li>
  <a href="schedule.html">Schedule</a>
</li>
<li>
  <a href="projects.html">Projects</a>
</li>
<li>
  <a href="exercise-06a.html">Next exercise</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">




</div>


<p><br />
</p>
<div
id="model-adequacy-using-posterior-predictive-simulations-in-revbayes"
class="section level1">
<h1>Model adequacy using posterior predictive simulations in
RevBayes</h1>
<p>In this exercise we will use posterior predictive simulations to
assess the fit of an evolutionary model to our data. We will test two
substitution models, Mk and Mkv+G. The code highlighted in this tutorial
is just to show the more important parts of a script. <strong>You do not
need to copy and paste them into the terminal</strong>. Instead, edit
the scripts in your editor and use <code>source(" ")</code>to read them
into RevBayes.</p>
<p>There are 6 rev scripts for the analysis:</p>
<ol style="list-style-type: decimal">
<li><code>MCMC_Simulation.Rev</code> runs an MCMC on your empirical
dataset and samples parameters from the posterior</li>
<li><code>PP_Simulation.Rev</code> takes the output from the first MCMC
to simulated new datasets under the chosen model</li>
<li><code>PP_MCMC.Rev</code> runs an MCMC for all the new datasets</li>
<li><code>Tree_Summary.Rev</code> generates test statistics</li>
<li><code>mk_Model.Rev</code> Mk substitution model script</li>
<li><code>mk+GV_Model.Rev</code> Mk+GV substitution model script</li>
</ol>
<p>and 1 R script <code>PPS_Analsis.r</code> to summarise the
output.</p>
<p>The data used here is a morphological matrix Brontornis taxa, an
extinct genus of giant flightless birds from Argentina. There are 12
taxa and 51 characters.</p>
<p>You can download everything <a
href="scripts/exercise07.zip">here</a>. Note unlike previous exercises
in this course, you don’t need to write any scripts from scratch. Simply
modify the existing scripts to run the analysis.</p>
<div id="read-in-the-data-and-define-the-subsitution-model-to-test"
class="section level3">
<h3>Read in the data and define the subsitution model to test</h3>
<p>Start with <code>MCMC_Simulation.rev</code> script. We first need to
read in our data and define which substitution model we will use for the
analysis, either Mk or Mkv+G.</p>
<pre class="r"><code>morpho &lt;- readDiscreteCharacterData(&quot;data/Agnolin_2007a_paleobiodb.nex&quot;)
analysis_name = &quot;model_adequacy&quot; 
model_name = &quot;model&quot; # what model are you testing? e.g. &quot;mk&quot;
model_file_name = &quot;scripts/&quot;+model_name+&quot;_Model.Rev&quot;</code></pre>
<p><strong>Note</strong>: These variables are at the start of the rev
scripts 1-4. Make sure you add the model you want to use to each
script.</p>
<p>This monitor samples the posterior and saves it to a file that can be
used to simulate new datasets under the chosen model.</p>
<pre class="r"><code>monitors.append( mnStochasticVariable(filename=&quot;output/&quot;  + model_name +  &quot;/output/&quot; + analysis_name + &quot;_posterior.var&quot;, printgen=10) )</code></pre>
</div>
<div id="mk-substitution-model" class="section level3">
<h3>Mk substitution model</h3>
<p>Helper variables and branch lengths are set up as in previous
exercises.</p>
<p>Specify the Jukes-Cantor substitution model applied uniformly to all
sites. Remember the Mk model is a generalization of the Jukes-Cantor
model.</p>
<pre class="r"><code>Q := fnJC(4) # this matrix has 4 different character states. 

seq ~ dnPhyloCTMC(tree=phylogeny, Q=Q, type=&quot;Standard&quot;)</code></pre>
</div>
<div id="mkv-gamma-substitution-model" class="section level3">
<h3>Mkv + Gamma substitution model</h3>
<p>Set up gamma-distributed rate variation.</p>
<pre class="r"><code>alpha_morpho ~ dnUniform( 0.0, 1E6 )
rates_morpho := fnDiscretizeGamma( alpha_morpho, alpha_morpho, 4 )
moves.append( mvScale(alpha_morpho, lambda=1, weight=2.0) )</code></pre>
<p>To account for ascertainment bias. Change the coding to
<code>variable</code>.</p>
<pre class="r"><code>seq ~ dnPhyloCTMC(tree=phylogeny, siteRates=rates_morpho, Q=Q, type=&quot;Standard&quot;,  coding=&quot;variable&quot;)</code></pre>
</div>
<div id="running-the-analysis" class="section level3">
<h3>Running the analysis</h3>
<p>Once you have chosen your model you can source the first script.</p>
<pre class="r"><code>source(&quot;scripts/1_MCMC_Simulation.Rev&quot;)</code></pre>
</div>
<div id="simulating-new-datasets" class="section level3">
<h3>Simulating new datasets</h3>
<p>We can now simulate new datasets. In this script pay attention to the
<code>thinning</code> variable. This number controls the number of
datasets simulated. We set it too 100 here so every 100th tree is used
in the <code>.var</code> file. In a standard analysis you would set this
a lot lower (e.g. 2).</p>
<pre class="r"><code>pps.run(thinning=100)</code></pre>
<pre class="r"><code>source(&quot;scripts/2_PP_Simulation.Rev&quot;)</code></pre>
</div>
<div id="mcmc-for-simulated-datasets" class="section level3">
<h3>MCMC for simulated datasets</h3>
<p>Next we need to run an MCMC for all of our simulated datasets. This
function runs an MCMC for all datasets in the directory file path.</p>
<pre class="r"><code>my_pps_mcmc = posteriorPredictiveAnalysis(mymcmc, directory)
my_pps_mcmc.run(generations=1000)</code></pre>
<pre class="r"><code>source(&quot;scripts/3_PP_MCMC.Rev&quot;)</code></pre>
</div>
<div id="generating-test-statistics" class="section level3">
<h3>Generating test statistics</h3>
<p>We can then generate some test statistics to assess how well each
model fit our data. This script calculates the tree length and the
Robinson-Foulds (RF) distance for both the empirical dataset and
simulated datasets. RF distance is one of several ways to measure the
distance between trees.</p>
<pre class="r"><code>source(&quot;scripts/4_Tree_Summary.Rev&quot;)</code></pre>
<p>Now run the whole analysis again (scripts 1-4) using the other
morphological model. Don’t forget to change the model name in each
one!</p>
</div>
<div id="producing-figures" class="section level3">
<h3>Producing figures</h3>
<p>Use the R script <code>PPS_Analysis.r</code>. If everything has been
run correctly up to now, you only need to set your working directory and
run this file.</p>
</div>
<div id="analysing-the-output" class="section level3">
<h3>Analysing the output</h3>
<p>The R script should produce a <code>Figures</code> directory
containing 3 files:</p>
<ol style="list-style-type: decimal">
<li><code>Boxplots.pdf</code> This figure contains boxplots of the
effect sizes for the 4 test statistics used here. The closer the plot is
to zero the more similar the simulated results are to the
empirical.</li>
</ol>
<p><img src="Boxplots.png" width="70%" style="padding:10px" /></p>
<ol start="2" style="list-style-type: decimal">
<li><code>Histograms.pdf</code> This figure shows the distribution of
tree length and Robinson Foulds distance across the simulated datasets.
The blue line shows the empirical values and the pink broken line shows
the mean of the simulated data.</li>
</ol>
<p><img src="Histrograms.png" width="70%" style="padding:10px" /></p>
<ol start="3" style="list-style-type: decimal">
<li><code>results.csv</code> Stores the effect sizes for each
model.</li>
</ol>
<p><img src="results.png" width="50%" style="padding:10px" /></p>
</div>
<div id="next-tasks" class="section level3">
<h3>Next Tasks</h3>
<p>Try simulating more datasets in the anaylsis (change the
<code>thinnning</code> variable). Does this change the results?</p>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
